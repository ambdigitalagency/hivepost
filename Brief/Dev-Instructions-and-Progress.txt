# HivePost MVP — 开发说明与进度（AI 记忆库）

---

## 如何阅读和使用本文件

**给人类：**  
本文件是给 AI 助手用的「项目记忆库」。当你开一个新对话、要接着做 HivePost 开发时，只需说：「请先读 Brief/Dev-Instructions-and-Progress.txt，了解项目情况和进度，然后从当前该做的步骤开始。」AI 会通过本文件知道项目背景、技术选型、已完成项和下一步该做什么。

**给 AI：**  
当你被要求「读这个文件」或「读 Dev-Instructions-and-Progress」时，请：  
1. 完整阅读本文件。  
2. 根据「当前阶段」和「步骤完成情况」确定用户现在该做哪一步。  
3. 若某步骤已勾选为完成，则从下一个未勾选的步骤开始；若用户说「刚做完某步」，则更新本文件中该步骤为完成，并引导进行下一步。  
4. 所有产品与流程细节以同目录下的 **PRD_Final.txt** 和 **Architecture.txt** 为准；本文件只做进度与操作指引，不替代 PRD/Architecture。

**文件位置：** 本文件位于项目根目录下的 `Brief/Dev-Instructions-and-Progress.txt`。同目录还有 `PRD_Final.txt`（产品需求）、`Architecture.txt`（架构要求）。

---

## 一、项目基本情况

- **产品名称：** HivePost (MVP)  
- **形态：** 从零开发的 Web 应用，目标验证「用户愿意用、会回来用」；成功后会发展为 SaaS。  
- **市场：** 仅美国；产品中英双语（EN + 中文）。  
- **用户：** 本地小微/个体户（如水电、清洁），多数无高等教育背景；文案与策略需简短、口语化、一看就懂。  
- **核心流程：** Google 登录 → 创建业务 → 粘贴内容（可选）→ Gatekeeper 校验 → 生成营销策略（SWOT + 推荐平台 >2，中文用户默认含小红书+微信朋友圈）→ 用户选 2 个平台 → 生成一个月内容日历（仅计划，不自动生成内容）→ **用户需登录并主动点击**从日历选一条生成文案+候选图 → 选最多 9 张做高质量最终图 → 导出。首次使用后告知「约 2 周后会再请填反馈」；约 2 周后收集 5 分评分 + 好的地方 + 需改进处。  
- **开发端口：** 固定为 **3001**。`npm run dev` 使用 `next dev -p 3001`；`NEXTAUTH_URL` 须为 `http://localhost:3001`。详见 MVP/README.md。
- **技术选型（MVP）：**  
  - 前端：Next.js（App Router），中英双语。  
  - 后端：同仓 API（Next.js API Routes 或小型服务），配额与预算强校验。  
  - 认证：仅 Google OAuth（如 Supabase Auth / NextAuth）。  
  - 数据库：Postgres（如 Supabase 或 Neon）。  
  - 存储：对象存储存图片（如 Supabase Storage 或 R2）。  
  - 文案 AI：OpenAI；图片 AI：成本优先（如 Replicate/Fal）。  
  - 部署：尽量简单（如 Vercel + Supabase）。  
- **预算：** 全局 API 预算 $100/月；有降级阶梯（减少候选数、最终图数、关闭「新一批」等）。  
- **产品原则（写死）：** 策略与界面文案必须短、白话语、无术语；Gatekeeper 宁误拦不滥用，拦截时仅提示「请修改输入后重试」；MVP 不支持修改策略，需明确告知用户。

更完整的产品与数据模型见 **Brief/PRD_Final.txt**，架构与接口见 **Brief/Architecture.txt**。

---

## 二、阶段与步骤总览

以下步骤按顺序执行。**完成一项后，在对应 `[ ]` 改为 `[x]` 并保存本文件**（或让 AI 在你有权限时代为更新），以便下次新窗口从正确步骤继续。

---

### 阶段 0：环境与准备（用户 0 编程/部署经验，需逐步拆解）

- [x] **0.1** 本机安装 Node.js（LTS），终端执行 `node -v` (版本v19.8.1)、`npm -v` (版本9.5.1) 。  
- [x] **0.2** 本机安装 Git，终端执行 `git --version` (版本2.50.1 Apple Git-155)。  
- [x] **0.3** 确认使用 Cursor 打开本项目，能在 Cursor 内打开终端。  
- [x] **0.4** 注册/准备后续会用到的账号（按步骤需要时再详细说明）：Google Cloud 用于 Google 登录；Supabase（DB + Auth + Storage）；Vercel（部署）；OpenAI；Replicate（图片）。  

**阶段 0 完成标志：** 能运行 `node -v`、`npm -v`、`git --version` 且输出正常；知道上述账号的用途与注册入口。

---

### 阶段 1：项目骨架与本地运行

- [x] **1.1** 在项目根目录创建 Next.js 项目（App Router），安装依赖，能通过 `npm run dev` 在本地跑起空白页。  
- [x] **1.2** 配置中英双语（i18n）骨架（至少能切换语言或占位）。  
- [x] **1.3** 添加最简布局：Landing 页 + 占位「登录」入口。  

**阶段 1 完成标志：** 本地访问 localhost 能看到 Landing，能切语言（或占位），有登录入口。

---

### 阶段 2：认证（Google 登录）

- [x] **2.1** 在 Google Cloud（或 Supabase Auth）中配置 OAuth，拿到所需 client id/secret。  
- [x] **2.2** 在项目中接入 Google 登录（如 Supabase Auth 或 NextAuth），登录后能获取并展示用户标识（如邮箱或名称）。  
- [x] **2.3** 保护「需登录」的页面：未登录时访问业务/策略/日历等则重定向到登录或 Landing。  

**阶段 2 完成标志：** 能通过 Google 登录，登录后能看到「已登录」状态；未登录无法进入后续流程。

---

### 阶段 3：数据库与核心数据模型

- [x] **3.1** 在 Supabase（或所选 Postgres）中创建 PRD §14 中的表：users, businesses, business_platforms, strategies, ingests, posts, image_batches, post_images, weekly_quota_usage, api_cost_ledger, events, feedback；若 Supabase Auth 已有 users，则与本地 users 表或业务表关联一致。  
- [x] **3.2** 实现「创建/更新业务」API 与最简前端（行业、地区、语言、语气等），并写入 `businesses`；实现「选择 2 个平台」并写入 `business_platforms`（校验最多 2 个）。  
- [x] **3.3** 实现 `first_used_at` 的更新逻辑（如首次导出或首次完成一条内容时写入 users 表），供后续「约 2 周后反馈」使用。  

**阶段 3 完成标志：** 能创建业务、选 2 个平台并持久化；DB 表与 PRD 一致；有首次使用时间可记。

---

### 阶段 4：Gatekeeper 与策略

- [x] **4.1** 实现 Gatekeeper 模块：对用户输入做意图/范围校验（是否与业务/营销相关），不通过则返回统一提示「请修改输入后重试」；在策略生成与内容生成入口调用。  
- [x] **4.2** 实现「粘贴内容」的提交与存储（PII 脱敏后写入 ingests），并与 Gatekeeper 串联。  
- [x] **4.3** 实现策略生成：输入为业务信息 + 可选 ingest；输出为短、白话语的 SWOT + 内容方向 + 推荐平台列表（>2）；中文用户推荐列表默认包含小红书、微信朋友圈。策略文案遵守「短、无术语」原则。  
- [x] **4.4** 策略展示页：展示策略内容 + 推荐平台列表；明确文案「本版本不支持修改策略，请确认后继续」；用户确认后进入平台选择。  

**阶段 4 完成标志：** 粘贴内容经 Gatekeeper 校验；能生成并展示策略；中文用户看到小红书+微信朋友圈在推荐中；用户确认后进入选平台。

---

### 阶段 5：内容日历与帖子生成

- [x] **5.1** 用户从策略推荐中选 2 个平台后，生成一个月内容日历：用 `posts` 表，`status=planned`，`scheduled_date` 与 `platform`、`content_type` 按 PRD 设定；无独立 calendar 表。**仅计划排期，不自动生成文案或图片**；用户需登录并主动点击某条才请求生成。
- [x] **5.2** 日历视图：展示当月排期（日期 + 平台 + 类型）；用户点击某条进入「生成该条」。
- [x] **5.3** 单条生成流程：从 planned 变为 draft；调用 Extractor + Copywriter + Risk Checker 生成文案；写入 `posts.caption_text` 等；展示编辑与「生成图片」入口。  
- [x] **5.4** 配额：每平台每周最多 2 条；在生成前校验 `weekly_quota_usage`，超限则拒绝并提示。  

**阶段 5 完成标志：** 选 2 平台后能看到一个月日历；能选一条生成文案并受配额限制；文案可编辑。

---

### 阶段 6：图片管线与导出

- [x] **6.1** 图片候选：调用图片 API 生成候选图（低质量、数量受预算阶梯限制），写入 `image_batches` 与 `post_images`，存储到对象存储。  
- [x] **6.2** 前端：候选图网格、多选（最多 9 张）、「最终化选中」按钮；最终化时只对选中图请求高质量版并写回 `post_images` 与存储。  
- [x] **6.3** 预算服务：维护 `api_cost_ledger`，实现 $100/月 总预算与降级阶梯（减少候选数/最终图数、关闭「新一批」等）；在候选与最终化前校验。  
- [x] **6.4** 导出：复制文案、下载图片；支持「标记已使用」；首次完成导出时更新 `first_used_at` 并显示「约 2 周后会再请填反馈」的提示。  

**阶段 6 完成标志：** 能生成候选图、选最多 9 张并最终化；导出可用；预算与配额被遵守；首次导出有 2 周反馈提示。

---

### 阶段 7：反馈与收尾

- [x] **7.1** 反馈表单：5 分制评分 +「好的地方」+「需改进的地方」；在「约 2 周后」（根据 `first_used_at` 判断）对未提交过反馈的用户展示邀请。  
- [x] **7.2** 提交后写入 `feedback` 表；埋点 `feedback_submitted`。  
- [x] **7.3** 事件埋点：按 PRD §11 补齐关键事件（如 strategy_confirmed, platforms_selected, content_calendar_generated, first_use_completed 等）。  

**阶段 7 完成标志：** 2 周后能弹出/展示反馈邀请；能提交并存储反馈；关键事件有埋点。

---

### 阶段 8：部署与上线

- [ ] **8.1** 将前端与 API 部署到 Vercel（或选定平台）；环境变量配置（API keys、Supabase URL/Key 等）。  
- [ ] **8.2** 配置生产环境 Supabase（及 OpenAI、图片服务等）；确认预算与配额在生产环境生效。  
- [ ] **8.3** （可选）配置自定义域名与 HTTPS。  

**阶段 8 完成标志：** 线上可访问；登录与核心流程在线上可用；预算与反馈逻辑正常。

---

## 三、当前进度（由 AI 或用户更新）

- **最后完成的步骤：** 阶段 7.3 完成（反馈表单与邀请、POST /api/feedback、PRD §11 关键事件埋点已补齐）  
- **下一步建议：** 阶段 8（部署与上线）  
- **备注：** 项目位于 `Content Generation Tool/MVP`，Next.js 14、App Router；Node v19.8.1。若遇 EMFILE 可提高系统「打开文件数」限制；后续可升级至 Node 20/22 以符合最新 create-next-app 要求。测试反馈邀请时可将环境变量 `FEEDBACK_INVITATION_DAYS=0` 以立即展示邀请（无需等 14 天）。

---

## 四、参考文件

- **PRD_Final.txt** — 完整产品需求、流程、数据模型、验收标准。  
- **Architecture.txt** — 架构目标、组件、API、数据表与安全/可靠性要求。

每次在新窗口开始时，先读本文件 + 按需读 PRD/Architecture，再从「下一步建议」或第一个未勾选步骤开始执行。
